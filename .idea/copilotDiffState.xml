<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/src/main/java/org/example/p2pfileshare/controller/RootController.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/src/main/java/org/example/p2pfileshare/controller/RootController.java" />
              <option name="originalContent" value="package org.example.p2pfileshare.controller;&#10;&#10;import javafx.application.Platform;&#10;import javafx.fxml.FXML;&#10;import javafx.scene.control.*;&#10;&#10;import org.example.p2pfileshare.model.PeerInfo;&#10;import org.example.p2pfileshare.network.control.ControlClient;&#10;import org.example.p2pfileshare.network.control.ControlServer;&#10;import org.example.p2pfileshare.network.discovery.PeerDiscovery;&#10;import org.example.p2pfileshare.service.FileShareService;&#10;import org.example.p2pfileshare.service.HistoryService;&#10;import org.example.p2pfileshare.service.PeerService;&#10;import org.example.p2pfileshare.service.SearchService;&#10;import org.example.p2pfileshare.util.AppConfig;&#10;&#10;import java.util.Random;&#10;import java.util.UUID;&#10;&#10;public class RootController {&#10;&#10;    // Include các tab con&#10;    @FXML private PeerTabController peerTabController;&#10;    @FXML private ShareTabController shareTabController;&#10;    @FXML private SearchTabController searchTabController;&#10;    @FXML private HistoryTabController historyTabController;&#10;&#10;    @FXML private TabPane mainTabPane;&#10;    @FXML private Label globalStatusLabel;&#10;    @FXML private Label userNameLabel; // hiển thị tên người dùng trên status bar&#10;&#10;    // Services&#10;    private PeerService peerService;&#10;    private FileShareService fileShareService;&#10;    private SearchService searchService;&#10;    private HistoryService historyService;&#10;&#10;    // Control channel&#10;    private ControlServer controlServer;&#10;    private ControlClient controlClient;&#10;&#10;    // Peer info&#10;    private String myPeerId;&#10;    private String myName; // displayName&#10;    private final int FILE_PORT      = 6000  + new Random().nextInt(1000);&#10;    private final int CONTROL_PORT   = 7000  + new Random().nextInt(1000);&#10;    private static final String KEY_PEER_NAME = &quot;peer_display_name&quot;;&#10;    @FXML&#10;    public void initialize() {&#10;&#10;        // 1) Hỏi tên peer&#10;        myName = loadOrAskPeerName();&#10;        myPeerId = UUID.randomUUID().toString();&#10;        historyService   = new HistoryService();&#10;        // 2) Khởi tạo service&#10;        peerService      = new PeerService(myPeerId, myName, FILE_PORT, CONTROL_PORT);&#10;        fileShareService = new FileShareService(FILE_PORT, historyService);&#10;        searchService    = new SearchService();&#10;&#10;&#10;        // 3) ControlClient để gửi request CONNECT (gửi peerId, displayName)&#10;        controlClient = new ControlClient(myPeerId, myName);&#10;&#10;        // 4) ControlServer để nhận CONNECT_REQUEST&#10;        controlServer = new ControlServer(CONTROL_PORT, fromPeer -&gt; {&#10;            // fromPeer là peerId của peer gửi yêu cầu&#10;            // Hỏi người dùng bằng JavaFX, nhưng phải block đến khi họ chọn xong&#10;            java.util.concurrent.atomic.AtomicBoolean accepted = new java.util.concurrent.atomic.AtomicBoolean(false);&#10;            java.util.concurrent.CountDownLatch latch = new java.util.concurrent.CountDownLatch(1);&#10;&#10;            javafx.application.Platform.runLater(() -&gt; {&#10;                Alert alert = new Alert(Alert.AlertType.CONFIRMATION);&#10;                alert.setTitle(&quot;Yêu cầu kết nối&quot;);&#10;                alert.setHeaderText(&quot;Peer &quot; + fromPeer + &quot; muốn kết nối với bạn&quot;);&#10;                alert.setContentText(&quot;Bạn có đồng ý không?&quot;);&#10;&#10;                var result = alert.showAndWait();&#10;                boolean ok = result.isPresent() &amp;&amp; result.get().getButtonData().isDefaultButton();&#10;                accepted.set(ok);&#10;                latch.countDown();&#10;            });&#10;&#10;            try {&#10;                latch.await();&#10;            } catch (InterruptedException e) {&#10;                Thread.currentThread().interrupt();&#10;            }&#10;&#10;            return accepted.get();&#10;        });&#10;        // inject FileShareService để phục vụ LIST_FILES&#10;        controlServer.setFileShareService(fileShareService);&#10;        controlServer.start();&#10;&#10;        System.out.println(&quot;[Root] ControlServer started at port &quot; + CONTROL_PORT);&#10;&#10;        // 5) Bật Discovery Responder&#10;        PeerDiscovery.startResponder(&#10;                myPeerId,&#10;                myName,&#10;                FILE_PORT,&#10;                CONTROL_PORT&#10;        );&#10;&#10;&#10;        // 6) Inject service vào UI controllers&#10;        if (peerTabController != null)&#10;            peerTabController.init(peerService, fileShareService, controlClient, globalStatusLabel);&#10;&#10;        if (shareTabController != null)&#10;            shareTabController.init(fileShareService, globalStatusLabel);&#10;&#10;        if (searchTabController != null)&#10;            searchTabController.init(searchService, fileShareService, controlClient, globalStatusLabel);&#10;&#10;        if (historyTabController != null)&#10;            historyTabController.init(historyService, globalStatusLabel);&#10;&#10;        globalStatusLabel.setText(&quot;Sẵn sàng&quot;);&#10;        // Hiển thị tên người dùng lên status bar (nếu Label đã được inject)&#10;        if (userNameLabel != null &amp;&amp; myName != null) {&#10;            userNameLabel.setText(myName);&#10;        }&#10;    }&#10;&#10;    // ================= MENU =================&#10;&#10;    @FXML&#10;    private void onChooseShareFolder() {&#10;        globalStatusLabel.setText(&quot;Hãy vào tab 'Tài liệu chia sẻ' để chọn thư mục.&quot;);&#10;        mainTabPane.getSelectionModel().select(1);&#10;    }&#10;&#10;    @FXML&#10;    private void onExit() {&#10;        mainTabPane.getScene().getWindow().hide();&#10;    }&#10;&#10;    @FXML&#10;    private void onAbout() {&#10;        Alert alert = new Alert(Alert.AlertType.INFORMATION);&#10;        alert.setTitle(&quot;Giới thiệu&quot;);&#10;        alert.setHeaderText(&quot;P2P File Sharing - JavaFX&quot;);&#10;        alert.setContentText(&quot;Ứng dụng chia sẻ file ngang hàng trong LAN.&quot;);&#10;        alert.showAndWait();&#10;    }&#10;&#10;    @FXML&#10;    private void onChangeName() {&#10;        var owner = mainTabPane != null &amp;&amp; mainTabPane.getScene() != null ? mainTabPane.getScene().getWindow() : null;&#10;        var opt = org.example.p2pfileshare.controller.ChangeNameController.showDialog(owner, myName);&#10;        if (opt.isPresent()) {&#10;            String newName = opt.get().trim();&#10;            if (!newName.isEmpty() &amp;&amp; !newName.equals(myName)) {&#10;                // 1) Lưu config&#10;                AppConfig.save(KEY_PEER_NAME, newName);&#10;&#10;                // 2) Cập nhật biến và UI&#10;                myName = newName;&#10;                if (userNameLabel != null) userNameLabel.setText(myName);&#10;&#10;                // 3) Cập nhật service/client&#10;                if (peerService != null) peerService.setMyDisplayName(myName);&#10;                if (controlClient != null) controlClient.setMyDisplayName(myName);&#10;&#10;                // 4) Refresh UI (quét lại peer list để cập nhật hiển thị nếu cần)&#10;                if (peerTabController != null) peerTabController.refresh();&#10;&#10;                globalStatusLabel.setText(&quot;Đã đổi tên thành: &quot; + myName);&#10;            }&#10;        }&#10;    }&#10;&#10;    // ================= HỖ TRỢ =================&#10;&#10;    private String loadOrAskPeerName() {&#10;        // 1) Load tên đã lưu&#10;        String saved = AppConfig.load(KEY_PEER_NAME);&#10;        if (saved != null &amp;&amp; !saved.isBlank()) {&#10;            return saved; // ✔ Có tên rồi → dùng luôn&#10;        }&#10;&#10;        // 2) Chưa có → hỏi tên người dùng&#10;        TextInputDialog dialog = new TextInputDialog(&quot;Peer1&quot;);&#10;        dialog.setTitle(&quot;Tên Peer&quot;);&#10;        dialog.setHeaderText(&quot;Nhập tên Peer:&quot;);&#10;        dialog.setContentText(&quot;Tên:&quot;);&#10;&#10;        String name = dialog.showAndWait().orElse(&quot;Peer_&quot; + System.currentTimeMillis());&#10;&#10;        // 3) Lưu lại để lần sau khỏi hỏi&#10;        AppConfig.save(KEY_PEER_NAME, name);&#10;&#10;        return name;&#10;    }&#10;}&#10;" />
              <option name="updatedContent" value="package org.example.p2pfileshare.controller;&#10;&#10;import javafx.application.Platform;&#10;import javafx.fxml.FXML;&#10;import javafx.scene.control.*;&#10;&#10;import org.example.p2pfileshare.model.PeerInfo;&#10;import org.example.p2pfileshare.network.control.ControlClient;&#10;import org.example.p2pfileshare.network.control.ControlServer;&#10;import org.example.p2pfileshare.network.discovery.PeerDiscovery;&#10;import org.example.p2pfileshare.service.FileShareService;&#10;import org.example.p2pfileshare.service.HistoryService;&#10;import org.example.p2pfileshare.service.PeerService;&#10;import org.example.p2pfileshare.service.SearchService;&#10;import org.example.p2pfileshare.util.AppConfig;&#10;&#10;import java.util.Random;&#10;import java.util.UUID;&#10;&#10;public class RootController {&#10;&#10;    // Include các tab con&#10;    @FXML private PeerTabController peerTabController;&#10;    @FXML private ShareTabController shareTabController;&#10;    @FXML private SearchTabController searchTabController;&#10;    @FXML private HistoryTabController historyTabController;&#10;    @FXML private IncomingConnectionController incomingConnectionTabController;&#10;&#10;    @FXML private TabPane mainTabPane;&#10;    @FXML private Label globalStatusLabel;&#10;    @FXML private Label userNameLabel; // hiển thị tên người dùng trên status bar&#10;&#10;    // Services&#10;    private PeerService peerService;&#10;    private FileShareService fileShareService;&#10;    private SearchService searchService;&#10;    private HistoryService historyService;&#10;&#10;    // Control channel&#10;    private ControlServer controlServer;&#10;    private ControlClient controlClient;&#10;&#10;    // Peer info&#10;    private String myPeerId;&#10;    private String myName; // displayName&#10;    private final int FILE_PORT      = 6000  + new Random().nextInt(1000);&#10;    private final int CONTROL_PORT   = 7000  + new Random().nextInt(1000);&#10;    private static final String KEY_PEER_NAME = &quot;peer_display_name&quot;;&#10;    @FXML&#10;    public void initialize() {&#10;&#10;        // 1) Hỏi tên peer&#10;        myName = loadOrAskPeerName();&#10;        myPeerId = UUID.randomUUID().toString();&#10;        historyService   = new HistoryService();&#10;        // 2) Khởi tạo service&#10;        peerService      = new PeerService(myPeerId, myName, FILE_PORT, CONTROL_PORT);&#10;        fileShareService = new FileShareService(FILE_PORT, historyService);&#10;        searchService    = new SearchService();&#10;&#10;&#10;        // 3) ControlClient để gửi request CONNECT (gửi peerId, displayName)&#10;        controlClient = new ControlClient(myPeerId, myName);&#10;&#10;        // 4) ControlServer để nhận CONNECT_REQUEST&#10;        controlServer = new ControlServer(CONTROL_PORT, fromPeer -&gt; {&#10;            // fromPeer là peerId của peer gửi yêu cầu&#10;            // Hỏi người dùng bằng JavaFX, nhưng phải block đến khi họ chọn xong&#10;            java.util.concurrent.atomic.AtomicBoolean accepted = new java.util.concurrent.atomic.AtomicBoolean(false);&#10;            java.util.concurrent.CountDownLatch latch = new java.util.concurrent.CountDownLatch(1);&#10;&#10;            javafx.application.Platform.runLater(() -&gt; {&#10;                Alert alert = new Alert(Alert.AlertType.CONFIRMATION);&#10;                alert.setTitle(&quot;Yêu cầu kết nối&quot;);&#10;                alert.setHeaderText(&quot;Peer &quot; + fromPeer + &quot; muốn kết nối với bạn&quot;);&#10;                alert.setContentText(&quot;Bạn có đồng ý không?&quot;);&#10;&#10;                var result = alert.showAndWait();&#10;                boolean ok = result.isPresent() &amp;&amp; result.get().getButtonData().isDefaultButton();&#10;                accepted.set(ok);&#10;                latch.countDown();&#10;            });&#10;&#10;            try {&#10;                latch.await();&#10;            } catch (InterruptedException e) {&#10;                Thread.currentThread().interrupt();&#10;            }&#10;&#10;            return accepted.get();&#10;        });&#10;        // inject FileShareService để phục vụ LIST_FILES&#10;        controlServer.setFileShareService(fileShareService);&#10;        controlServer.start();&#10;&#10;        System.out.println(&quot;[Root] ControlServer started at port &quot; + CONTROL_PORT);&#10;&#10;        // 5) Bật Discovery Responder&#10;        PeerDiscovery.startResponder(&#10;                myPeerId,&#10;                myName,&#10;                FILE_PORT,&#10;                CONTROL_PORT&#10;        );&#10;&#10;&#10;        // 6) Inject service vào UI controllers&#10;        if (peerTabController != null)&#10;            peerTabController.init(peerService, fileShareService, controlClient, globalStatusLabel);&#10;&#10;        if (shareTabController != null)&#10;            shareTabController.init(fileShareService, globalStatusLabel);&#10;&#10;        if (searchTabController != null)&#10;            searchTabController.init(searchService, fileShareService, controlClient, globalStatusLabel);&#10;&#10;        if (historyTabController != null)&#10;            historyTabController.init(historyService, globalStatusLabel);&#10;&#10;        if (incomingConnectionTabController != null)&#10;            incomingConnectionTabController.init(peerService, controlServer, globalStatusLabel);&#10;&#10;        globalStatusLabel.setText(&quot;Sẵn sàng&quot;);&#10;        // Hiển thị tên người dùng lên status bar (nếu Label đã được inject)&#10;        if (userNameLabel != null &amp;&amp; myName != null) {&#10;            userNameLabel.setText(myName);&#10;        }&#10;    }&#10;&#10;    // ================= MENU =================&#10;&#10;    @FXML&#10;    private void onChooseShareFolder() {&#10;        globalStatusLabel.setText(&quot;Hãy vào tab 'Tài liệu chia sẻ' để chọn thư mục.&quot;);&#10;        mainTabPane.getSelectionModel().select(1);&#10;    }&#10;&#10;    @FXML&#10;    private void onExit() {&#10;        mainTabPane.getScene().getWindow().hide();&#10;    }&#10;&#10;    @FXML&#10;    private void onAbout() {&#10;        Alert alert = new Alert(Alert.AlertType.INFORMATION);&#10;        alert.setTitle(&quot;Giới thiệu&quot;);&#10;        alert.setHeaderText(&quot;P2P File Sharing - JavaFX&quot;);&#10;        alert.setContentText(&quot;Ứng dụng chia sẻ file ngang hàng trong LAN.&quot;);&#10;        alert.showAndWait();&#10;    }&#10;&#10;    @FXML&#10;    private void onChangeName() {&#10;        var owner = mainTabPane != null &amp;&amp; mainTabPane.getScene() != null ? mainTabPane.getScene().getWindow() : null;&#10;        var opt = org.example.p2pfileshare.controller.ChangeNameController.showDialog(owner, myName);&#10;        if (opt.isPresent()) {&#10;            String newName = opt.get().trim();&#10;            if (!newName.isEmpty() &amp;&amp; !newName.equals(myName)) {&#10;                // 1) Lưu config&#10;                AppConfig.save(KEY_PEER_NAME, newName);&#10;&#10;                // 2) Cập nhật biến và UI&#10;                myName = newName;&#10;                if (userNameLabel != null) userNameLabel.setText(myName);&#10;&#10;                // 3) Cập nhật service/client&#10;                if (peerService != null) peerService.setMyDisplayName(myName);&#10;                if (controlClient != null) controlClient.setMyDisplayName(myName);&#10;&#10;                // 4) Refresh UI (quét lại peer list để cập nhật hiển thị nếu cần)&#10;                if (peerTabController != null) peerTabController.refresh();&#10;&#10;                globalStatusLabel.setText(&quot;Đã đổi tên thành: &quot; + myName);&#10;            }&#10;        }&#10;    }&#10;&#10;    // ================= HỖ TRỢ =================&#10;&#10;    private String loadOrAskPeerName() {&#10;        // 1) Load tên đã lưu&#10;        String saved = AppConfig.load(KEY_PEER_NAME);&#10;        if (saved != null &amp;&amp; !saved.isBlank()) {&#10;            return saved; // ✔ Có tên rồi → dùng luôn&#10;        }&#10;&#10;        // 2) Chưa có → hỏi tên người dùng&#10;        TextInputDialog dialog = new TextInputDialog(&quot;Peer1&quot;);&#10;        dialog.setTitle(&quot;Tên Peer&quot;);&#10;        dialog.setHeaderText(&quot;Nhập tên Peer:&quot;);&#10;        dialog.setContentText(&quot;Tên:&quot;);&#10;&#10;        String name = dialog.showAndWait().orElse(&quot;Peer_&quot; + System.currentTimeMillis());&#10;&#10;        // 3) Lưu lại để lần sau khỏi hỏi&#10;        AppConfig.save(KEY_PEER_NAME, name);&#10;&#10;        return name;&#10;    }&#10;}&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>